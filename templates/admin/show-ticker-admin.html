{% extends "/admin/base-admin.html" %}

{% block title %}Ticker List{% endblock %}

{% block content %}
<head>
    <style>
        /* General body styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            width: 100vw;
            height: auto; /* Changed to auto for height adjustment */
        }
        /* Header styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #333;
            padding: 15px 30px;
            color: #fff;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
        }

        /* User profile on the top right */
        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-profile img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .user-profile .username {
            margin-right: 15px;
            font-size: 16px;
        }

        .user-profile .logout-btn {
            background-color: #ff4d4d;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Ticker-Notes cell style */
        .ticker-notes {
            max-height: 2.6em; /* Approximately two lines of text */
            overflow-y: auto;  /* Enable vertical scrolling */
            white-space: normal; /* Allow text to wrap */
            word-wrap: break-word; /* Break long words if necessary */
            display: block; /* Ensures the div behaves like a block element */
        }

        /* Custom scrollbar styling (optional) */
        .ticker-notes::-webkit-scrollbar {
            width: 5px; /* Width of the scrollbar */
        }

        .ticker-notes::-webkit-scrollbar-thumb {
            background-color: #888; /* Color of the scrollbar */
            border-radius: 4px;
        }

        .ticker-notes::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }
        /* Container and Table styles */
        .container {
            width: 90%;
            margin: 30px auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
        }
        /* Set column width percentages */
        .col-1 { width: 15%; }
        .col-2 { width: 15%; }
        .col-3 { width: 6%; }
        .col-4 { width: 6%; }
        .col-5 { width: 6%; }
        .col-6 { width: 6%; }
        .col-7 { width: 6%; }
        .col-8 { width: 6%; }
        .col-9 { width: 6%; }
        .col-10 { width: 20%; }
        .col-11 { width: 7%; }
        th {
            background-color: #007bff; /* Change header background color */
            color: #fff; /* White text for header */
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .editable {
            background-color: #ffffe0; /* Light yellow to indicate edit mode */
        }

        /* Icons */
        .action-icons {
            cursor: pointer;
            margin-right: 10px;
        }
        /* Search bar styles */
        .search-bar {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-bar input[type="text"], .search-bar select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
        }

        .search-bar button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .search-bar button:hover {
            background-color: #218838;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header,
            .container {
                width: 100%;
                padding: 10px;
            }

            .search-bar input[type="text"],
            .search-bar select {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>

    <script>
        // Function to filter table rows based on search input and dropdown filters
        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const tables = document.querySelectorAll('.ticker-table');

            tables.forEach(table => {
                const tr = table.getElementsByTagName('tr');
                for (let i = 1; i < tr.length; i++) {
                    let tdArray = tr[i].getElementsByTagName('td');
                    let rowMatchFound = false;

                    for (let j = 0; j < tdArray.length; j++) {
                        let td = tdArray[j];
                        if (td && td.innerText.toUpperCase().indexOf(filter) > -1) {
                            rowMatchFound = true;
                        }
                    }
                    tr[i].style.display = rowMatchFound ? "" : "none";
                }
            });
        }

        // Function to toggle the visibility of the table
        function toggleTable(tableId) {
            const table = document.getElementById(tableId);
            const button = document.getElementById(`toggle-${tableId}`);
            if (table.style.display === "none" || table.style.display === "") {
                table.style.display = "table"; // Show the table
                button.innerHTML = "-"; // Change button text to minus
            } else {
                table.style.display = "none"; // Hide the table
                button.innerHTML = "+"; // Change button text to plus
            }
        }
        // Make the row editable
        function editRow(rowId) {
            let row = document.getElementById(rowId);
            let cells = row.getElementsByTagName("td");

            // Add editable attributes to each cell
            for (let i = 1; i < cells.length - 1; i++) {
                let cell = cells[i];
                let content = cell.innerText;
                cell.innerHTML = `<input type="text" value="${content}" />`;
                cell.classList.add("editable");
            }
        }

        // Update the row and send data to the backend
        function updateRow(rowId) {
            let row = document.getElementById(rowId);
            let cells = row.getElementsByTagName("td");
            let updatedData = {};

            // Extract updated values
            updatedData['created_date'] = cells[0].innerText;
            updatedData['ticker_name'] = cells[1].querySelector('input').value;
            updatedData['entry_price'] = cells[2].querySelector('input').value;
            updatedData['stop_percent'] = cells[3].querySelector('input').value;
            updatedData['stop_price'] = cells[4].querySelector('input').value;
            updatedData['target_1'] = cells[5].querySelector('input').value;
            updatedData['target_2'] = cells[6].querySelector('input').value;
            updatedData['target_3'] = cells[7].querySelector('input').value;
            updatedData['target_4'] = cells[8].querySelector('input').value;
            updatedData['ticker_notes'] = cells[9].querySelector('input').value;

            // Call the backend to update the data
            fetch('/update_ticker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Update successful");
                    // Remove edit mode styling and replace inputs with text
                    for (let i = 1; i < cells.length - 1; i++) {
                        let cell = cells[i];
                        let input = cell.querySelector('input');
                        cell.innerText = input.value;
                        cell.classList.remove("editable");
                    }
                } else {
                    alert("Update failed");
                }
            })
            .catch(error => {
                console.error("Error updating the row:", error);
                alert("An error occurred while updating the row");
            });
        }

        // Toggle visibility of tables by date
        function toggleTable(tableId) {
            const table = document.getElementById(tableId);
            const button = document.getElementById(`toggle-${tableId}`);
            if (table.style.display === "none" || table.style.display === "") {
                table.style.display = "table"; // Show the table
                button.innerHTML = "-"; // Change button text to minus
            } else {
                table.style.display = "none"; // Hide the table
                button.innerHTML = "+"; // Change button text to plus
            }
        }

        // On page load, only expand the first table by default
        window.onload = function() {
            const tables = document.querySelectorAll('.ticker-table');
            tables.forEach((table, index) => {
                if (index !== 0) {
                    table.style.display = "none"; // Hide all tables except the first one
                }
            });
        };
    </script>
</head>
<body>
    <!-- Main container -->
    <div class="container">
        <!-- Search bar -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search tickers..." onkeyup="filterTable()">
            <button onclick="filterTable()">Search</button>
        </div>
        <!-- Display a single table for each date -->
        {% for date, entries in grouped_tickers.items() %}
        <h3>
            <button id="toggle-table-{{ date }}" onclick="toggleTable('table-{{ date }}')">-</button>
            {{ date }}
        </h3>
        <table id="table-{{ date }}" class="ticker-table">
            <thead>
                <tr>
                    <th class="col-1">Created-Date</th>
                    <th class="col-2">Ticker-Name</th>
                    <th class="col-3">Entry Price</th>
                    <th class="col-4">Stop %</th>
                    <th class="col-5">Stop Price</th>
                    <th class="col-6">Target-1</th>
                    <th class="col-7">Target-2</th>
                    <th class="col-8">Target-3</th>
                    <th class="col-9">Target-4</th>
                    <th class="col-10">Ticker-Notes</th>
                    <th class="col-11">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for ticker in entries %}
                <tr id="row-{{ ticker.id }}">
                    <td>{{ ticker.created_date }}</td>
                    <td>{{ ticker.ticker_name }}</td>
                    <td>{{ ticker.entry_price }}</td>
                    <td>{{ ticker.stop_percent }}</td>
                    <td>{{ ticker.stop_price }}</td>
                    <td>{{ ticker.target_1 }}</td>
                    <td>{{ ticker.target_2 }}</td>
                    <td>{{ ticker.target_3 }}</td>
                    <td>{{ ticker.target_4 }}</td>
                    <td>
                        <div class="ticker-notes">{{ ticker.ticker_notes }}</div>
                    </td>
                    <td>
                        <span class="action-icons" onclick="editRow('row-{{ ticker.id }}')">✏️ </span>
                        <span class="action-icons" onclick="updateRow('row-{{ ticker.id }}')">✅</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
    </div>
</body>

{% endblock %}
